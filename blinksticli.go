package main

import (
    "flag"
    "fmt"
    "time"
    "github.com/boombuler/led"
    "image/color"
    "math/rand"
    "os"
    "sort"
    "strings"
    "regexp"
    "encoding/hex"
)

var flagSetColor string
var flagListColorNames bool

var colors map[string]*color.RGBA

func init() {
    flag.StringVar(&flagSetColor, "set-color", "", "Set color for device. The format must be \"#rrggbb\" or \"random\" or an HTML color name, like \"green\"")
    flag.BoolVar(&flagListColorNames, "list-color-names", false, "list all available HTML color names")
    initColors()
}

func initColors() {
    colors = make(map[string]*color.RGBA)
    colors["aliceblue"] = &color.RGBA{0xf0, 0xf8, 0xff, 0xFF}
    colors["antiquewhite"] = &color.RGBA{0xfa, 0xeb, 0xd7, 0xFF}
    colors["aqua"] = &color.RGBA{0x00, 0xff, 0xff, 0xFF}
    colors["aquamarine"] = &color.RGBA{0x7f, 0xff, 0xd4, 0xFF}
    colors["azure"] = &color.RGBA{0xf0, 0xff, 0xff, 0xFF}
    colors["beige"] = &color.RGBA{0xf5, 0xf5, 0xdc, 0xFF}
    colors["bisque"] = &color.RGBA{0xff, 0xe4, 0xc4, 0xFF}
    colors["black"] = &color.RGBA{0x00, 0x00, 0x00, 0xFF}
    colors["blanchedalmond"] = &color.RGBA{0xff, 0xeb, 0xcd, 0xFF}
    colors["blue"] = &color.RGBA{0x00, 0x00, 0xff, 0xFF}
    colors["blueviolet"] = &color.RGBA{0x8a, 0x2b, 0xe2, 0xFF}
    colors["brown"] = &color.RGBA{0xa5, 0x2a, 0x2a, 0xFF}
    colors["burlywood"] = &color.RGBA{0xde, 0xb8, 0x87, 0xFF}
    colors["cadetblue"] = &color.RGBA{0x5f, 0x9e, 0xa0, 0xFF}
    colors["chartreuse"] = &color.RGBA{0x7f, 0xff, 0x00, 0xFF}
    colors["chocolate"] = &color.RGBA{0xd2, 0x69, 0x1e, 0xFF}
    colors["coral"] = &color.RGBA{0xff, 0x7f, 0x50, 0xFF}
    colors["cornflowerblue"] = &color.RGBA{0x64, 0x95, 0xed, 0xFF}
    colors["cornsilk"] = &color.RGBA{0xff, 0xf8, 0xdc, 0xFF}
    colors["crimson"] = &color.RGBA{0xdc, 0x14, 0x3c, 0xFF}
    colors["cyan"] = &color.RGBA{0x00, 0xff, 0xff, 0xFF}
    colors["darkblue"] = &color.RGBA{0x00, 0x00, 0x8b, 0xFF}
    colors["darkcyan"] = &color.RGBA{0x00, 0x8b, 0x8b, 0xFF}
    colors["darkgoldenrod"] = &color.RGBA{0xb8, 0x86, 0x0b, 0xFF}
    colors["darkgray"] = &color.RGBA{0xa9, 0xa9, 0xa9, 0xFF}
    colors["darkgrey"] = &color.RGBA{0xa9, 0xa9, 0xa9, 0xFF}
    colors["darkgreen"] = &color.RGBA{0x00, 0x64, 0x00, 0xFF}
    colors["darkkhaki"] = &color.RGBA{0xbd, 0xb7, 0x6b, 0xFF}
    colors["darkmagenta"] = &color.RGBA{0x8b, 0x00, 0x8b, 0xFF}
    colors["darkolivegreen"] = &color.RGBA{0x55, 0x6b, 0x2f, 0xFF}
    colors["darkorange"] = &color.RGBA{0xff, 0x8c, 0x00, 0xFF}
    colors["darkorchid"] = &color.RGBA{0x99, 0x32, 0xcc, 0xFF}
    colors["darkred"] = &color.RGBA{0x8b, 0x00, 0x00, 0xFF}
    colors["darksalmon"] = &color.RGBA{0xe9, 0x96, 0x7a, 0xFF}
    colors["darkseagreen"] = &color.RGBA{0x8f, 0xbc, 0x8f, 0xFF}
    colors["darkslateblue"] = &color.RGBA{0x48, 0x3d, 0x8b, 0xFF}
    colors["darkslategray"] = &color.RGBA{0x2f, 0x4f, 0x4f, 0xFF}
    colors["darkslategrey"] = &color.RGBA{0x2f, 0x4f, 0x4f, 0xFF}
    colors["darkturquoise"] = &color.RGBA{0x00, 0xce, 0xd1, 0xFF}
    colors["darkviolet"] = &color.RGBA{0x94, 0x00, 0xd3, 0xFF}
    colors["deeppink"] = &color.RGBA{0xff, 0x14, 0x93, 0xFF}
    colors["deepskyblue"] = &color.RGBA{0x00, 0xbf, 0xff, 0xFF}
    colors["dimgray"] = &color.RGBA{0x69, 0x69, 0x69, 0xFF}
    colors["dimgrey"] = &color.RGBA{0x69, 0x69, 0x69, 0xFF}
    colors["dodgerblue"] = &color.RGBA{0x1e, 0x90, 0xff, 0xFF}
    colors["firebrick"] = &color.RGBA{0xb2, 0x22, 0x22, 0xFF}
    colors["floralwhite"] = &color.RGBA{0xff, 0xfa, 0xf0, 0xFF}
    colors["forestgreen"] = &color.RGBA{0x22, 0x8b, 0x22, 0xFF}
    colors["fuchsia"] = &color.RGBA{0xff, 0x00, 0xff, 0xFF}
    colors["gainsboro"] = &color.RGBA{0xdc, 0xdc, 0xdc, 0xFF}
    colors["ghostwhite"] = &color.RGBA{0xf8, 0xf8, 0xff, 0xFF}
    colors["gold"] = &color.RGBA{0xff, 0xd7, 0x00, 0xFF}
    colors["goldenrod"] = &color.RGBA{0xda, 0xa5, 0x20, 0xFF}
    colors["gray"] = &color.RGBA{0x80, 0x80, 0x80, 0xFF}
    colors["grey"] = &color.RGBA{0x80, 0x80, 0x80, 0xFF}
    colors["green"] = &color.RGBA{0x00, 0x80, 0x00, 0xFF}
    colors["greenyellow"] = &color.RGBA{0xad, 0xff, 0x2f, 0xFF}
    colors["honeydew"] = &color.RGBA{0xf0, 0xff, 0xf0, 0xFF}
    colors["hotpink"] = &color.RGBA{0xff, 0x69, 0xb4, 0xFF}
    colors["indianred"] = &color.RGBA{0xcd, 0x5c, 0x5c, 0xFF}
    colors["indigo"] = &color.RGBA{0x4b, 0x00, 0x82, 0xFF}
    colors["ivory"] = &color.RGBA{0xff, 0xff, 0xf0, 0xFF}
    colors["khaki"] = &color.RGBA{0xf0, 0xe6, 0x8c, 0xFF}
    colors["lavender"] = &color.RGBA{0xe6, 0xe6, 0xfa, 0xFF}
    colors["lavenderblush"] = &color.RGBA{0xff, 0xf0, 0xf5, 0xFF}
    colors["lawngreen"] = &color.RGBA{0x7c, 0xfc, 0x00, 0xFF}
    colors["lemonchiffon"] = &color.RGBA{0xff, 0xfa, 0xcd, 0xFF}
    colors["lightblue"] = &color.RGBA{0xad, 0xd8, 0xe6, 0xFF}
    colors["lightcoral"] = &color.RGBA{0xf0, 0x80, 0x80, 0xFF}
    colors["lightcyan"] = &color.RGBA{0xe0, 0xff, 0xff, 0xFF}
    colors["lightgoldenrodyellow"] = &color.RGBA{0xfa, 0xfa, 0xd2, 0xFF}
    colors["lightgray"] = &color.RGBA{0xd3, 0xd3, 0xd3, 0xFF}
    colors["lightgrey"] = &color.RGBA{0xd3, 0xd3, 0xd3, 0xFF}
    colors["lightgreen"] = &color.RGBA{0x90, 0xee, 0x90, 0xFF}
    colors["lightpink"] = &color.RGBA{0xff, 0xb6, 0xc1, 0xFF}
    colors["lightsalmon"] = &color.RGBA{0xff, 0xa0, 0x7a, 0xFF}
    colors["lightseagreen"] = &color.RGBA{0x20, 0xb2, 0xaa, 0xFF}
    colors["lightskyblue"] = &color.RGBA{0x87, 0xce, 0xfa, 0xFF}
    colors["lightslategray"] = &color.RGBA{0x77, 0x88, 0x99, 0xFF}
    colors["lightslategrey"] = &color.RGBA{0x77, 0x88, 0x99, 0xFF}
    colors["lightsteelblue"] = &color.RGBA{0xb0, 0xc4, 0xde, 0xFF}
    colors["lightyellow"] = &color.RGBA{0xff, 0xff, 0xe0, 0xFF}
    colors["lime"] = &color.RGBA{0x00, 0xff, 0x00, 0xFF}
    colors["limegreen"] = &color.RGBA{0x32, 0xcd, 0x32, 0xFF}
    colors["linen"] = &color.RGBA{0xfa, 0xf0, 0xe6, 0xFF}
    colors["magenta"] = &color.RGBA{0xff, 0x00, 0xff, 0xFF}
    colors["maroon"] = &color.RGBA{0x80, 0x00, 0x00, 0xFF}
    colors["mediumaquamarine"] = &color.RGBA{0x66, 0xcd, 0xaa, 0xFF}
    colors["mediumblue"] = &color.RGBA{0x00, 0x00, 0xcd, 0xFF}
    colors["mediumorchid"] = &color.RGBA{0xba, 0x55, 0xd3, 0xFF}
    colors["mediumpurple"] = &color.RGBA{0x93, 0x70, 0xd8, 0xFF}
    colors["mediumseagreen"] = &color.RGBA{0x3c, 0xb3, 0x71, 0xFF}
    colors["mediumslateblue"] = &color.RGBA{0x7b, 0x68, 0xee, 0xFF}
    colors["mediumspringgreen"] = &color.RGBA{0x00, 0xfa, 0x9a, 0xFF}
    colors["mediumturquoise"] = &color.RGBA{0x48, 0xd1, 0xcc, 0xFF}
    colors["mediumvioletred"] = &color.RGBA{0xc7, 0x15, 0x85, 0xFF}
    colors["midnightblue"] = &color.RGBA{0x19, 0x19, 0x70, 0xFF}
    colors["mintcream"] = &color.RGBA{0xf5, 0xff, 0xfa, 0xFF}
    colors["mistyrose"] = &color.RGBA{0xff, 0xe4, 0xe1, 0xFF}
    colors["moccasin"] = &color.RGBA{0xff, 0xe4, 0xb5, 0xFF}
    colors["navajowhite"] = &color.RGBA{0xff, 0xde, 0xad, 0xFF}
    colors["navy"] = &color.RGBA{0x00, 0x00, 0x80, 0xFF}
    colors["oldlace"] = &color.RGBA{0xfd, 0xf5, 0xe6, 0xFF}
    colors["olive"] = &color.RGBA{0x80, 0x80, 0x00, 0xFF}
    colors["olivedrab"] = &color.RGBA{0x6b, 0x8e, 0x23, 0xFF}
    colors["orange"] = &color.RGBA{0xff, 0xa5, 0x00, 0xFF}
    colors["orangered"] = &color.RGBA{0xff, 0x45, 0x00, 0xFF}
    colors["orchid"] = &color.RGBA{0xda, 0x70, 0xd6, 0xFF}
    colors["palegoldenrod"] = &color.RGBA{0xee, 0xe8, 0xaa, 0xFF}
    colors["palegreen"] = &color.RGBA{0x98, 0xfb, 0x98, 0xFF}
    colors["paleturquoise"] = &color.RGBA{0xaf, 0xee, 0xee, 0xFF}
    colors["palevioletred"] = &color.RGBA{0xd8, 0x70, 0x93, 0xFF}
    colors["papayawhip"] = &color.RGBA{0xff, 0xef, 0xd5, 0xFF}
    colors["peachpuff"] = &color.RGBA{0xff, 0xda, 0xb9, 0xFF}
    colors["peru"] = &color.RGBA{0xcd, 0x85, 0x3f, 0xFF}
    colors["pink"] = &color.RGBA{0xff, 0xc0, 0xcb, 0xFF}
    colors["plum"] = &color.RGBA{0xdd, 0xa0, 0xdd, 0xFF}
    colors["powderblue"] = &color.RGBA{0xb0, 0xe0, 0xe6, 0xFF}
    colors["purple"] = &color.RGBA{0x80, 0x00, 0x80, 0xFF}
    colors["red"] = &color.RGBA{0xff, 0x00, 0x00, 0xFF}
    colors["rosybrown"] = &color.RGBA{0xbc, 0x8f, 0x8f, 0xFF}
    colors["royalblue"] = &color.RGBA{0x41, 0x69, 0xe1, 0xFF}
    colors["saddlebrown"] = &color.RGBA{0x8b, 0x45, 0x13, 0xFF}
    colors["salmon"] = &color.RGBA{0xfa, 0x80, 0x72, 0xFF}
    colors["sandybrown"] = &color.RGBA{0xf4, 0xa4, 0x60, 0xFF}
    colors["seagreen"] = &color.RGBA{0x2e, 0x8b, 0x57, 0xFF}
    colors["seashell"] = &color.RGBA{0xff, 0xf5, 0xee, 0xFF}
    colors["sienna"] = &color.RGBA{0xa0, 0x52, 0x2d, 0xFF}
    colors["silver"] = &color.RGBA{0xc0, 0xc0, 0xc0, 0xFF}
    colors["skyblue"] = &color.RGBA{0x87, 0xce, 0xeb, 0xFF}
    colors["slateblue"] = &color.RGBA{0x6a, 0x5a, 0xcd, 0xFF}
    colors["slategray"] = &color.RGBA{0x70, 0x80, 0x90, 0xFF}
    colors["slategrey"] = &color.RGBA{0x70, 0x80, 0x90, 0xFF}
    colors["snow"] = &color.RGBA{0xff, 0xfa, 0xfa, 0xFF}
    colors["springgreen"] = &color.RGBA{0x00, 0xff, 0x7f, 0xFF}
    colors["steelblue"] = &color.RGBA{0x46, 0x82, 0xb4, 0xFF}
    colors["tan"] = &color.RGBA{0xd2, 0xb4, 0x8c, 0xFF}
    colors["teal"] = &color.RGBA{0x00, 0x80, 0x80, 0xFF}
    colors["thistle"] = &color.RGBA{0xd8, 0xbf, 0xd8, 0xFF}
    colors["tomato"] = &color.RGBA{0xff, 0x63, 0x47, 0xFF}
    colors["turquoise"] = &color.RGBA{0x40, 0xe0, 0xd0, 0xFF}
    colors["violet"] = &color.RGBA{0xee, 0x82, 0xee, 0xFF}
    colors["wheat"] = &color.RGBA{0xf5, 0xde, 0xb3, 0xFF}
    colors["white"] = &color.RGBA{0xff, 0xff, 0xff, 0xFF}
    colors["whitesmoke"] = &color.RGBA{0xf5, 0xf5, 0xf5, 0xFF}
    colors["yellow"] = &color.RGBA{0xff, 0xff, 0x00, 0xFF}
    colors["yellowgreen"] = &color.RGBA{0x9a, 0xcd, 0x32, 0xFF}
}

func printListColorNames() {
    var colorNames []string
    for k := range colors {
        colorNames = append(colorNames, k)
    }
    sort.Strings(colorNames)
    for k := range colorNames {
        if (k > 0) {
            fmt.Print(",")
        }
        fmt.Print(colorNames[k])
    }
}

func getFlagColor() color.Color {
    flagSetColor = strings.ToLower(flagSetColor)
    if (flagSetColor == "random") {
        rand.Seed(time.Now().UnixNano())
        return color.RGBA{uint8(rand.Int()), uint8(rand.Int()), uint8(rand.Int()), 0xFF}
    }
    if (colors[flagSetColor] != nil) {
        return colors[flagSetColor]
    }
    validHexCode := regexp.MustCompile(`^#?([a-f0-9]{6})$`)
    if (validHexCode.MatchString(flagSetColor)) {
        hexStr := validHexCode.FindStringSubmatch(flagSetColor)
        bytes, err := hex.DecodeString(hexStr[1])
        if (err != nil) {
            fmt.Printf("invalid color code '%s'. use '#rrggbb' instead", hexStr[1])
            return nil
        }
        return color.RGBA{uint8(bytes[0]), uint8(bytes[1]), uint8(bytes[2]), 0xFF}
    }
    return nil
}

func main() {

    flag.Parse()

    if (len(os.Args) == 1) {
        flag.Usage()
    }

    if (flagListColorNames) {
        printListColorNames()
    }

    if (len(flagSetColor) < 1) {
        os.Exit(0)
    }

    for devInfo := range led.Devices() {
        dev, err := devInfo.Open()
        if err != nil {
            fmt.Println(err)
            continue
        }
        defer dev.Close()

        col := getFlagColor()
        if (col != nil) {
            dev.SetColor(col)
        }

        time.Sleep(2 * time.Second)
    }

}
